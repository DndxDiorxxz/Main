-- Settings
local HoldClick = true
local Hotkey = 't'
local ToggleOffKey = 'q' 
local HotkeyToggle = true

-- Cache everything
local Players = game:GetService('Players')
local RunService = game:GetService('RunService')
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local Toggle = Hotkey ~= ''
local CurrentlyPressed = false

-- Pre-cache functions
local mouse1press = mouse1press
local mouse1click = mouse1click
local mouse1release = mouse1release
local FindFirstChild = game.FindFirstChild
local FindFirstChildOfClass = game.FindFirstChildOfClass

-- Humanoid detection function (cached for performance)
local function hasHumanoid(character)
    if not character then return false end
    
    -- Fast path: check for Humanoid directly first
    local humanoid = FindFirstChildOfClass(character, 'Humanoid')
    if humanoid then return true end
    
    -- Check common rig types and custom rig patterns
    if FindFirstChild(character, 'Humanoid') then return true end
    
    -- Check for common rig components that indicate a player character
    if FindFirstChild(character, 'Head') and FindFirstChild(character, 'Torso') then
        return true
    end
    
    -- Check for R15 rig components
    if FindFirstChild(character, 'Head') and FindFirstChild(character, 'UpperTorso') then
        return true
    end
    
    -- Check for common custom rig patterns
    if FindFirstChild(character, 'Head') and (FindFirstChild(character, 'Body') or FindFirstChild(character, 'Mesh')) then
        return true
    end
    
    return false
end

-- Single optimized connection
Mouse.KeyDown:Connect(function(key)
    if key == Hotkey then
        Toggle = HotkeyToggle and not Toggle or true
    end
end)

Mouse.KeyUp:Connect(function(key)
    if key == Hotkey and not HotkeyToggle then
        Toggle = false
    end
end)

-- Ultra-optimized main loop
RunService.RenderStepped:Connect(function()
    if not Toggle then return end
    
    local target = Mouse.Target
    if not target then
        if HoldClick and CurrentlyPressed then
            CurrentlyPressed = false
            mouse1release()
        end
        return
    end
    
    local parent = target.Parent
    if not parent then
        if HoldClick and CurrentlyPressed then
            CurrentlyPressed = false
            mouse1release()
        end
        return
    end
    
    -- Check if target's parent or any ancestor up to 3 levels has humanoid/character
    local current = parent
    local depth = 0
    local isCharacter = false
    
    while current and depth < 4 do -- Limit depth to prevent infinite loops
        if hasHumanoid(current) then
            isCharacter = true
            break
        end
        current = current.Parent
        depth += 1
    end
    
    if isCharacter then
        if HoldClick then
            if not CurrentlyPressed then
                CurrentlyPressed = true
                mouse1press()
            end
        else
            mouse1click()
        end
    elseif HoldClick and CurrentlyPressed then
        CurrentlyPressed = false
        mouse1release()
    end
end)
